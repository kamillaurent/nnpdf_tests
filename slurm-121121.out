
CondaError: Run 'conda init' before 'conda activate'

2025-04-03 19:39:33.348320: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: SSE4.1 SSE4.2 AVX AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
[INFO]: Creating replica output folder in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_1
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[INFO]: All requirements processed and checked successfully. Executing actions.
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_F2U
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_XGL
[INFO]: Loading integrability dataset NNPDF_INTEG_3GEV_XT3
[INFO]: Setting debug seed to: 13
[INFO]: Clearing session
[INFO]: Setting the number of cores to: 1
[INFO]: Starting sequential fits from replica 1 to 1
[INFO]: Starting replica fit (1,)
[INFO]: Clearing session
[INFO]: Generating layers
[INFO]: Generating layers for experiment DEUTERON
[INFO]: Generating layers for experiment ATLAS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_F2U
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_XGL
[INFO]: Generating integrability penalty for NNPDF_INTEG_3GEV_XT3
[INFO]: Generating the input grid
[INFO]: Generating PDF models
[INFO]: Generating the Model
Using Keras backend

Model: "meta_model"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ PDFs (MetaModel)    │ (1, 1, None, 14)  │        309 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ splitter (Lambda)   │ [(1, 1, 62, 14),  │          0 │ PDFs[0][0]        │
│                     │ (1, 1, 38, 14),   │            │                   │
│                     │ (1, 1, 50, 14),   │            │                   │
│                     │ (1, 1, 2, 14)]    │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON_split      │ [(1, 1, 36, 14),  │          0 │ splitter[0][0]    │
│ (Lambda)            │ (1, 1, 26, 14)]   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NMC_NC_NOTFIXE… │ (1, 1, 121)       │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_SLAC_NC_NOTFIX… │ (1, 1, 34)        │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_ATLAS_Z0J_8TEV… │ (1, 1, 44)        │          0 │ splitter[0][1]    │
│ (DY)                │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 20)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 19)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 10)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate         │ (1, 1, 155)       │          0 │ dat_NMC_NC_NOTFI… │
│ (Concatenate)       │                   │            │ dat_SLAC_NC_NOTF… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_1       │ (1, 1, 44)        │          0 │ dat_ATLAS_Z0J_8T… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_2       │ (1, 1, 20)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_3       │ (1, 1, 19)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_4       │ (1, 1, 10)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_INTEG_3G… │ (1, 1, 1)         │          0 │ splitter[0][3]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_DEUTERON     │ (1, 1, 115)       │          0 │ concatenate[0][0] │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_ATLAS (Mask) │ (1, 1, 33)        │          0 │ concatenate_1[0]… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 20)        │          0 │ concatenate_2[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 19)        │          0 │ concatenate_3[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 10)        │          0 │ concatenate_4[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_5       │ (1, 1, 1)         │          0 │ dat_NNPDF_INTEG_… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON            │ (1)               │     13,340 │ trmask_DEUTERON[… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ ATLAS               │ (1)               │      1,122 │ trmask_ATLAS[0][… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_INTEG_3GEV_X… │ (1)               │          1 │ concatenate_5[0]… │
│ (LossIntegrability) │                   │            │                   │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 14,775 (57.71 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 14,472 (56.53 KB)
Model: "PDFs"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_logx (Lambda)     │ (1, None, 2)      │          0 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ preprocessing_fact… │ (1, 1, None, 8)   │         16 │ pdf_input[0][0],  │
│ (Preprocessing)     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ all_NNs (MetaModel) │ (1, 1, None, 8)   │        293 │ x_logx[0][0],     │
│                     │                   │            │ x_logx[1][0]      │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ prefactor_times_NN  │ (1, 1, None, 8)   │          0 │ preprocessing_fa… │
│ (Lambda)            │                   │            │ all_NNs[0][0],    │
│                     │                   │            │ preprocessing_fa… │
│                     │                   │            │ all_NNs[1][0]     │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_evolution_basis │ (1, 1, None, 9)   │          0 │ prefactor_times_… │
│ (FlavourToEvolutio… │                   │            │ prefactor_times_… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_FK_basis        │ (1, 1, None, 14)  │          0 │ pdf_evolution_ba… │
│ (FkRotation)        │                   │            │ pdf_evolution_ba… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ impose_msr          │ (1, 1, None, 14)  │          0 │ pdf_FK_basis[0][… │
│ (MetaModel)         │                   │            │ pdf_FK_basis[1][… │
│                     │                   │            │ xgrid_integratio… │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 309 (1.21 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 6 (24.00 B)
Model: "all_NNs"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ NN_input (InputLayer)           │ (1, None, 2)           │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ NN_0 (MetaModel)                │ (1, None, 8)           │           293 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ stack_replicas (Lambda)         │ (1, 1, None, 8)        │             0 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 293 (1.14 KB)
 Trainable params: 293 (1.14 KB)
 Non-trainable params: 0 (0.00 B)
Model: "impose_msr"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_divide (xDivide)  │ (1, None, 14)     │          0 │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_xgrid_integrat… │ (1, 1, 2000, 14)  │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_integrand       │ (1, 1, 2000, 14)  │          0 │ x_divide[0][0],   │
│ (Lambda)            │                   │            │ pdf_xgrid_integr… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_integrator        │ (1, 1, 14)        │          0 │ pdf_integrand[0]… │
│ (xIntegrator)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ photon_integral     │ (1, 1, 1)         │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_x (InputLayer)  │ (1, 1, None, 14)  │          0 │ -                 │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ msr_weights         │ (1, 1, 14)        │          0 │ x_integrator[0][… │
│ (MSR_Normalization) │                   │            │ photon_integral[… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_normalized      │ (1, 1, None, 14)  │          0 │ pdf_x[0][0],      │
│ (Lambda)            │                   │            │ msr_weights[0][0] │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 0 (0.00 B)
 Trainable params: 0 (0.00 B)
 Non-trainable params: 0 (0.00 B)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'pdf_input': 'pdf_input', 'xgrid_integration': 'xgrid_integration'}
Received: inputs={'pdf_input': 'Tensor(shape=(1, 152, 1))', 'xgrid_integration': 'Tensor(shape=(1, 2000, 1))'}
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 2000, 2))
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 152, 2))
  warnings.warn(msg)
[INFO]:  > Latest 100 average: 0.015601 s
[INFO]: Epoch 100/900: loss: 392.2934570
Validation loss after training step: 2.5690706.
Validation chi2s: DEUTERON: 2.587, ATLAS: 2.505, total: 2.569
[INFO]:  > Latest 100 average: 0.021166 s
[INFO]: Epoch 200/900: loss: 367.1726074
Validation loss after training step: 2.0631120.
Validation chi2s: DEUTERON: 1.951, ATLAS: 2.470, total: 2.063
[INFO]:  > Latest 100 average: 0.014483 s
[INFO]: Epoch 300/900: loss: 350.5461731
Validation loss after training step: 1.7556418.
Validation chi2s: DEUTERON: 1.720, ATLAS: 1.885, total: 1.756
[INFO]:  > Latest 100 average: 0.013028 s
[INFO]: Epoch 400/900: loss: 344.6770325
Validation loss after training step: 1.6996824.
Validation chi2s: DEUTERON: 1.681, ATLAS: 1.767, total: 1.700
[INFO]:  > Latest 100 average: 0.012367 s
[INFO]: Epoch 500/900: loss: 325.4270325
Validation loss after training step: 1.6598908.
Validation chi2s: DEUTERON: 1.634, ATLAS: 1.752, total: 1.660
[INFO]:  > Latest 100 average: 0.012252 s
[INFO]: Epoch 600/900: loss: 331.2020264
Validation loss after training step: 1.6126825.
Validation chi2s: DEUTERON: 1.584, ATLAS: 1.718, total: 1.613
[INFO]:  > Latest 100 average: 0.011632 s
[INFO]: Epoch 700/900: loss: 313.8684082
Validation loss after training step: 1.6246289.
Validation chi2s: DEUTERON: 1.594, ATLAS: 1.735, total: 1.625
[INFO]:  > Latest 100 average: 0.011293 s
[INFO]: Epoch 800/900: loss: 297.5269470
Validation loss after training step: 1.7408712.
Validation chi2s: DEUTERON: 1.699, ATLAS: 1.892, total: 1.741
[INFO]:  > Latest 100 average: 0.011413 s
[INFO]: Epoch 900/900: loss: 286.5106201
Validation loss after training step: 1.8967644.
Validation chi2s: DEUTERON: 1.876, ATLAS: 1.973, total: 1.897
[INFO]: > > Average time per epoch: 0.012248 +- 0.0039319 s
[INFO]: > > > Total time: 0.20548 min
[INFO]: Stopped at epoch=900
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 199, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 120ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 129ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 12ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 21ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 12ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 21ms/step
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, None, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 136ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 146ms/step
[INFO]: Best fit for replica #1, chi2=0.877 (tr=1.973, vl=1.595)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 13ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 22ms/step
[INFO]:  > Saving the weights for future in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_1/weights.h5
[INFO]: Tensorboard logging information is stored at /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_1/tboard
2025-04-03 19:39:59.449447: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: SSE4.1 SSE4.2 AVX AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
[INFO]: Creating replica output folder in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_2
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[INFO]: All requirements processed and checked successfully. Executing actions.
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_F2U
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_XGL
[INFO]: Loading integrability dataset NNPDF_INTEG_3GEV_XT3
[INFO]: Setting debug seed to: 13
[INFO]: Clearing session
[INFO]: Setting the number of cores to: 1
[INFO]: Starting sequential fits from replica 2 to 2
[INFO]: Starting replica fit (2,)
[INFO]: Clearing session
[INFO]: Generating layers
[INFO]: Generating layers for experiment DEUTERON
[INFO]: Generating layers for experiment ATLAS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_F2U
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_XGL
[INFO]: Generating integrability penalty for NNPDF_INTEG_3GEV_XT3
[INFO]: Generating the input grid
[INFO]: Generating PDF models
[INFO]: Generating the Model
Using Keras backend

Model: "meta_model"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ PDFs (MetaModel)    │ (1, 1, None, 14)  │        309 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ splitter (Lambda)   │ [(1, 1, 62, 14),  │          0 │ PDFs[0][0]        │
│                     │ (1, 1, 38, 14),   │            │                   │
│                     │ (1, 1, 50, 14),   │            │                   │
│                     │ (1, 1, 2, 14)]    │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON_split      │ [(1, 1, 36, 14),  │          0 │ splitter[0][0]    │
│ (Lambda)            │ (1, 1, 26, 14)]   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NMC_NC_NOTFIXE… │ (1, 1, 121)       │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_SLAC_NC_NOTFIX… │ (1, 1, 34)        │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_ATLAS_Z0J_8TEV… │ (1, 1, 44)        │          0 │ splitter[0][1]    │
│ (DY)                │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 20)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 19)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 10)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate         │ (1, 1, 155)       │          0 │ dat_NMC_NC_NOTFI… │
│ (Concatenate)       │                   │            │ dat_SLAC_NC_NOTF… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_1       │ (1, 1, 44)        │          0 │ dat_ATLAS_Z0J_8T… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_2       │ (1, 1, 20)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_3       │ (1, 1, 19)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_4       │ (1, 1, 10)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_INTEG_3G… │ (1, 1, 1)         │          0 │ splitter[0][3]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_DEUTERON     │ (1, 1, 115)       │          0 │ concatenate[0][0] │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_ATLAS (Mask) │ (1, 1, 33)        │          0 │ concatenate_1[0]… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 20)        │          0 │ concatenate_2[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 19)        │          0 │ concatenate_3[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 10)        │          0 │ concatenate_4[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_5       │ (1, 1, 1)         │          0 │ dat_NNPDF_INTEG_… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON            │ (1)               │     13,340 │ trmask_DEUTERON[… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ ATLAS               │ (1)               │      1,122 │ trmask_ATLAS[0][… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_INTEG_3GEV_X… │ (1)               │          1 │ concatenate_5[0]… │
│ (LossIntegrability) │                   │            │                   │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 14,775 (57.71 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 14,472 (56.53 KB)
Model: "PDFs"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_logx (Lambda)     │ (1, None, 2)      │          0 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ preprocessing_fact… │ (1, 1, None, 8)   │         16 │ pdf_input[0][0],  │
│ (Preprocessing)     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ all_NNs (MetaModel) │ (1, 1, None, 8)   │        293 │ x_logx[0][0],     │
│                     │                   │            │ x_logx[1][0]      │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ prefactor_times_NN  │ (1, 1, None, 8)   │          0 │ preprocessing_fa… │
│ (Lambda)            │                   │            │ all_NNs[0][0],    │
│                     │                   │            │ preprocessing_fa… │
│                     │                   │            │ all_NNs[1][0]     │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_evolution_basis │ (1, 1, None, 9)   │          0 │ prefactor_times_… │
│ (FlavourToEvolutio… │                   │            │ prefactor_times_… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_FK_basis        │ (1, 1, None, 14)  │          0 │ pdf_evolution_ba… │
│ (FkRotation)        │                   │            │ pdf_evolution_ba… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ impose_msr          │ (1, 1, None, 14)  │          0 │ pdf_FK_basis[0][… │
│ (MetaModel)         │                   │            │ pdf_FK_basis[1][… │
│                     │                   │            │ xgrid_integratio… │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 309 (1.21 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 6 (24.00 B)
Model: "all_NNs"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ NN_input (InputLayer)           │ (1, None, 2)           │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ NN_0 (MetaModel)                │ (1, None, 8)           │           293 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ stack_replicas (Lambda)         │ (1, 1, None, 8)        │             0 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 293 (1.14 KB)
 Trainable params: 293 (1.14 KB)
 Non-trainable params: 0 (0.00 B)
Model: "impose_msr"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_divide (xDivide)  │ (1, None, 14)     │          0 │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_xgrid_integrat… │ (1, 1, 2000, 14)  │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_integrand       │ (1, 1, 2000, 14)  │          0 │ x_divide[0][0],   │
│ (Lambda)            │                   │            │ pdf_xgrid_integr… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_integrator        │ (1, 1, 14)        │          0 │ pdf_integrand[0]… │
│ (xIntegrator)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ photon_integral     │ (1, 1, 1)         │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_x (InputLayer)  │ (1, 1, None, 14)  │          0 │ -                 │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ msr_weights         │ (1, 1, 14)        │          0 │ x_integrator[0][… │
│ (MSR_Normalization) │                   │            │ photon_integral[… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_normalized      │ (1, 1, None, 14)  │          0 │ pdf_x[0][0],      │
│ (Lambda)            │                   │            │ msr_weights[0][0] │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 0 (0.00 B)
 Trainable params: 0 (0.00 B)
 Non-trainable params: 0 (0.00 B)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'pdf_input': 'pdf_input', 'xgrid_integration': 'xgrid_integration'}
Received: inputs={'pdf_input': 'Tensor(shape=(1, 152, 1))', 'xgrid_integration': 'Tensor(shape=(1, 2000, 1))'}
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 2000, 2))
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 152, 2))
  warnings.warn(msg)
[INFO]:  > Latest 100 average: 0.016424 s
[INFO]: Epoch 100/900: loss: 306.9375000
Validation loss after training step: 1.9159712.
Validation chi2s: DEUTERON: 2.143, ATLAS: 1.091, total: 1.916
[INFO]:  > Latest 100 average: 0.014485 s
[INFO]: Epoch 200/900: loss: 272.3938293
Validation loss after training step: 1.8116380.
Validation chi2s: DEUTERON: 2.069, ATLAS: 0.877, total: 1.812
[INFO]:  > Latest 100 average: 0.025248 s
[INFO]: Epoch 300/900: loss: 262.8577576
Validation loss after training step: 1.8002521.
Validation chi2s: DEUTERON: 1.999, ATLAS: 1.077, total: 1.800
[INFO]:  > Latest 100 average: 0.011631 s
[INFO]: Epoch 400/900: loss: 257.5519409
Validation loss after training step: 1.6906321.
Validation chi2s: DEUTERON: 1.946, ATLAS: 0.763, total: 1.691
[INFO]:  > Latest 100 average: 0.01187 s
[INFO]: Epoch 500/900: loss: 259.0165100
Validation loss after training step: 1.6446161.
Validation chi2s: DEUTERON: 1.887, ATLAS: 0.762, total: 1.645
[INFO]:  > Latest 100 average: 0.011832 s
[INFO]: Epoch 600/900: loss: 259.2522583
Validation loss after training step: 1.7156036.
Validation chi2s: DEUTERON: 1.891, ATLAS: 1.079, total: 1.716
[INFO]:  > Latest 100 average: 0.011257 s
[INFO]: Epoch 700/900: loss: 253.9947815
Validation loss after training step: 1.6294372.
Validation chi2s: DEUTERON: 1.856, ATLAS: 0.804, total: 1.629
[INFO]: > > Average time per epoch: 0.014126 +- 0.05015 s
[INFO]: > > > Total time: 0.18468 min
[INFO]: Stopped at epoch=759
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 199, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 121ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 130ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 12ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 21ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 12ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 21ms/step
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, None, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 137ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 146ms/step
[INFO]: Best fit for replica #2, chi2=0.811 (tr=1.719, vl=1.597)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 16ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 25ms/step
[INFO]:  > Saving the weights for future in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_2/weights.h5
[INFO]: Tensorboard logging information is stored at /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_2/tboard
2025-04-03 19:40:24.561402: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: SSE4.1 SSE4.2 AVX AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
[INFO]: Creating replica output folder in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_3
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[INFO]: All requirements processed and checked successfully. Executing actions.
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_F2U
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_XGL
[INFO]: Loading integrability dataset NNPDF_INTEG_3GEV_XT3
[INFO]: Setting debug seed to: 13
[INFO]: Clearing session
[INFO]: Setting the number of cores to: 1
[INFO]: Starting sequential fits from replica 3 to 3
[INFO]: Starting replica fit (3,)
[INFO]: Clearing session
[INFO]: Generating layers
[INFO]: Generating layers for experiment DEUTERON
[INFO]: Generating layers for experiment ATLAS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_F2U
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_XGL
[INFO]: Generating integrability penalty for NNPDF_INTEG_3GEV_XT3
[INFO]: Generating the input grid
[INFO]: Generating PDF models
[INFO]: Generating the Model
Using Keras backend

Model: "meta_model"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ PDFs (MetaModel)    │ (1, 1, None, 14)  │        309 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ splitter (Lambda)   │ [(1, 1, 62, 14),  │          0 │ PDFs[0][0]        │
│                     │ (1, 1, 38, 14),   │            │                   │
│                     │ (1, 1, 50, 14),   │            │                   │
│                     │ (1, 1, 2, 14)]    │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON_split      │ [(1, 1, 36, 14),  │          0 │ splitter[0][0]    │
│ (Lambda)            │ (1, 1, 26, 14)]   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NMC_NC_NOTFIXE… │ (1, 1, 121)       │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_SLAC_NC_NOTFIX… │ (1, 1, 34)        │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_ATLAS_Z0J_8TEV… │ (1, 1, 44)        │          0 │ splitter[0][1]    │
│ (DY)                │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 20)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 19)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 10)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate         │ (1, 1, 155)       │          0 │ dat_NMC_NC_NOTFI… │
│ (Concatenate)       │                   │            │ dat_SLAC_NC_NOTF… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_1       │ (1, 1, 44)        │          0 │ dat_ATLAS_Z0J_8T… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_2       │ (1, 1, 20)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_3       │ (1, 1, 19)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_4       │ (1, 1, 10)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_INTEG_3G… │ (1, 1, 1)         │          0 │ splitter[0][3]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_DEUTERON     │ (1, 1, 115)       │          0 │ concatenate[0][0] │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_ATLAS (Mask) │ (1, 1, 33)        │          0 │ concatenate_1[0]… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 20)        │          0 │ concatenate_2[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 19)        │          0 │ concatenate_3[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 10)        │          0 │ concatenate_4[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_5       │ (1, 1, 1)         │          0 │ dat_NNPDF_INTEG_… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON            │ (1)               │     13,340 │ trmask_DEUTERON[… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ ATLAS               │ (1)               │      1,122 │ trmask_ATLAS[0][… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_INTEG_3GEV_X… │ (1)               │          1 │ concatenate_5[0]… │
│ (LossIntegrability) │                   │            │                   │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 14,775 (57.71 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 14,472 (56.53 KB)
Model: "PDFs"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_logx (Lambda)     │ (1, None, 2)      │          0 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ preprocessing_fact… │ (1, 1, None, 8)   │         16 │ pdf_input[0][0],  │
│ (Preprocessing)     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ all_NNs (MetaModel) │ (1, 1, None, 8)   │        293 │ x_logx[0][0],     │
│                     │                   │            │ x_logx[1][0]      │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ prefactor_times_NN  │ (1, 1, None, 8)   │          0 │ preprocessing_fa… │
│ (Lambda)            │                   │            │ all_NNs[0][0],    │
│                     │                   │            │ preprocessing_fa… │
│                     │                   │            │ all_NNs[1][0]     │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_evolution_basis │ (1, 1, None, 9)   │          0 │ prefactor_times_… │
│ (FlavourToEvolutio… │                   │            │ prefactor_times_… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_FK_basis        │ (1, 1, None, 14)  │          0 │ pdf_evolution_ba… │
│ (FkRotation)        │                   │            │ pdf_evolution_ba… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ impose_msr          │ (1, 1, None, 14)  │          0 │ pdf_FK_basis[0][… │
│ (MetaModel)         │                   │            │ pdf_FK_basis[1][… │
│                     │                   │            │ xgrid_integratio… │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 309 (1.21 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 6 (24.00 B)
Model: "all_NNs"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ NN_input (InputLayer)           │ (1, None, 2)           │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ NN_0 (MetaModel)                │ (1, None, 8)           │           293 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ stack_replicas (Lambda)         │ (1, 1, None, 8)        │             0 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 293 (1.14 KB)
 Trainable params: 293 (1.14 KB)
 Non-trainable params: 0 (0.00 B)
Model: "impose_msr"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_divide (xDivide)  │ (1, None, 14)     │          0 │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_xgrid_integrat… │ (1, 1, 2000, 14)  │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_integrand       │ (1, 1, 2000, 14)  │          0 │ x_divide[0][0],   │
│ (Lambda)            │                   │            │ pdf_xgrid_integr… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_integrator        │ (1, 1, 14)        │          0 │ pdf_integrand[0]… │
│ (xIntegrator)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ photon_integral     │ (1, 1, 1)         │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_x (InputLayer)  │ (1, 1, None, 14)  │          0 │ -                 │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ msr_weights         │ (1, 1, 14)        │          0 │ x_integrator[0][… │
│ (MSR_Normalization) │                   │            │ photon_integral[… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_normalized      │ (1, 1, None, 14)  │          0 │ pdf_x[0][0],      │
│ (Lambda)            │                   │            │ msr_weights[0][0] │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 0 (0.00 B)
 Trainable params: 0 (0.00 B)
 Non-trainable params: 0 (0.00 B)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'pdf_input': 'pdf_input', 'xgrid_integration': 'xgrid_integration'}
Received: inputs={'pdf_input': 'Tensor(shape=(1, 152, 1))', 'xgrid_integration': 'Tensor(shape=(1, 2000, 1))'}
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 2000, 2))
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 152, 2))
  warnings.warn(msg)
[INFO]:  > Latest 100 average: 0.015564 s
[INFO]: Epoch 100/900: loss: 322.4062500
Validation loss after training step: 1.8184104.
Validation chi2s: DEUTERON: 2.141, ATLAS: 0.645, total: 1.818
[INFO]:  > Latest 100 average: 0.015903 s
[INFO]: Epoch 200/900: loss: 280.9140930
Validation loss after training step: 1.7219959.
Validation chi2s: DEUTERON: 2.041, ATLAS: 0.561, total: 1.722
[INFO]:  > Latest 100 average: 0.012288 s
[INFO]: Epoch 300/900: loss: 278.5845337
Validation loss after training step: 1.6334957.
Validation chi2s: DEUTERON: 1.923, ATLAS: 0.580, total: 1.633
[INFO]:  > Latest 100 average: 0.011711 s
[INFO]: Epoch 400/900: loss: 278.5473328
Validation loss after training step: 1.5679221.
Validation chi2s: DEUTERON: 1.835, ATLAS: 0.598, total: 1.568
[INFO]:  > Latest 100 average: 0.011061 s
[INFO]: Epoch 500/900: loss: 277.2457886
Validation loss after training step: 1.5411987.
Validation chi2s: DEUTERON: 1.794, ATLAS: 0.622, total: 1.541
[INFO]:  > Latest 100 average: 0.011094 s
[INFO]: Epoch 600/900: loss: 277.3554688
Validation loss after training step: 1.5141538.
Validation chi2s: DEUTERON: 1.753, ATLAS: 0.646, total: 1.514
[INFO]:  > Latest 100 average: 0.011104 s
[INFO]: Epoch 700/900: loss: 277.5136719
Validation loss after training step: 1.4657623.
Validation chi2s: DEUTERON: 1.688, ATLAS: 0.659, total: 1.466
[INFO]: > > Average time per epoch: 0.011885 +- 0.0037543 s
[INFO]: > > > Total time: 0.15221 min
[INFO]: Stopped at epoch=722
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 199, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 121ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 130ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 13ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 22ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 12ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 21ms/step
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, None, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 140ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 149ms/step
[INFO]: Best fit for replica #3, chi2=0.907 (tr=1.875, vl=1.417)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 14ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 24ms/step
[INFO]:  > Saving the weights for future in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_3/weights.h5
[INFO]: Tensorboard logging information is stored at /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_3/tboard
2025-04-03 19:40:46.991749: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: SSE4.1 SSE4.2 AVX AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
[INFO]: Creating replica output folder in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_4
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[INFO]: All requirements processed and checked successfully. Executing actions.
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_F2U
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_XGL
[INFO]: Loading integrability dataset NNPDF_INTEG_3GEV_XT3
[INFO]: Setting debug seed to: 13
[INFO]: Clearing session
[INFO]: Setting the number of cores to: 1
[INFO]: Starting sequential fits from replica 4 to 4
[INFO]: Starting replica fit (4,)
[INFO]: Clearing session
[INFO]: Generating layers
[INFO]: Generating layers for experiment DEUTERON
[INFO]: Generating layers for experiment ATLAS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_F2U
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_XGL
[INFO]: Generating integrability penalty for NNPDF_INTEG_3GEV_XT3
[INFO]: Generating the input grid
[INFO]: Generating PDF models
[INFO]: Generating the Model
Using Keras backend

Model: "meta_model"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ PDFs (MetaModel)    │ (1, 1, None, 14)  │        309 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ splitter (Lambda)   │ [(1, 1, 62, 14),  │          0 │ PDFs[0][0]        │
│                     │ (1, 1, 38, 14),   │            │                   │
│                     │ (1, 1, 50, 14),   │            │                   │
│                     │ (1, 1, 2, 14)]    │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON_split      │ [(1, 1, 36, 14),  │          0 │ splitter[0][0]    │
│ (Lambda)            │ (1, 1, 26, 14)]   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NMC_NC_NOTFIXE… │ (1, 1, 121)       │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_SLAC_NC_NOTFIX… │ (1, 1, 34)        │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_ATLAS_Z0J_8TEV… │ (1, 1, 44)        │          0 │ splitter[0][1]    │
│ (DY)                │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 20)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 19)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 10)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate         │ (1, 1, 155)       │          0 │ dat_NMC_NC_NOTFI… │
│ (Concatenate)       │                   │            │ dat_SLAC_NC_NOTF… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_1       │ (1, 1, 44)        │          0 │ dat_ATLAS_Z0J_8T… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_2       │ (1, 1, 20)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_3       │ (1, 1, 19)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_4       │ (1, 1, 10)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_INTEG_3G… │ (1, 1, 1)         │          0 │ splitter[0][3]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_DEUTERON     │ (1, 1, 115)       │          0 │ concatenate[0][0] │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_ATLAS (Mask) │ (1, 1, 33)        │          0 │ concatenate_1[0]… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 20)        │          0 │ concatenate_2[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 19)        │          0 │ concatenate_3[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 10)        │          0 │ concatenate_4[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_5       │ (1, 1, 1)         │          0 │ dat_NNPDF_INTEG_… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON            │ (1)               │     13,340 │ trmask_DEUTERON[… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ ATLAS               │ (1)               │      1,122 │ trmask_ATLAS[0][… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_INTEG_3GEV_X… │ (1)               │          1 │ concatenate_5[0]… │
│ (LossIntegrability) │                   │            │                   │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 14,775 (57.71 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 14,472 (56.53 KB)
Model: "PDFs"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_logx (Lambda)     │ (1, None, 2)      │          0 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ preprocessing_fact… │ (1, 1, None, 8)   │         16 │ pdf_input[0][0],  │
│ (Preprocessing)     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ all_NNs (MetaModel) │ (1, 1, None, 8)   │        293 │ x_logx[0][0],     │
│                     │                   │            │ x_logx[1][0]      │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ prefactor_times_NN  │ (1, 1, None, 8)   │          0 │ preprocessing_fa… │
│ (Lambda)            │                   │            │ all_NNs[0][0],    │
│                     │                   │            │ preprocessing_fa… │
│                     │                   │            │ all_NNs[1][0]     │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_evolution_basis │ (1, 1, None, 9)   │          0 │ prefactor_times_… │
│ (FlavourToEvolutio… │                   │            │ prefactor_times_… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_FK_basis        │ (1, 1, None, 14)  │          0 │ pdf_evolution_ba… │
│ (FkRotation)        │                   │            │ pdf_evolution_ba… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ impose_msr          │ (1, 1, None, 14)  │          0 │ pdf_FK_basis[0][… │
│ (MetaModel)         │                   │            │ pdf_FK_basis[1][… │
│                     │                   │            │ xgrid_integratio… │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 309 (1.21 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 6 (24.00 B)
Model: "all_NNs"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ NN_input (InputLayer)           │ (1, None, 2)           │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ NN_0 (MetaModel)                │ (1, None, 8)           │           293 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ stack_replicas (Lambda)         │ (1, 1, None, 8)        │             0 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 293 (1.14 KB)
 Trainable params: 293 (1.14 KB)
 Non-trainable params: 0 (0.00 B)
Model: "impose_msr"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_divide (xDivide)  │ (1, None, 14)     │          0 │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_xgrid_integrat… │ (1, 1, 2000, 14)  │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_integrand       │ (1, 1, 2000, 14)  │          0 │ x_divide[0][0],   │
│ (Lambda)            │                   │            │ pdf_xgrid_integr… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_integrator        │ (1, 1, 14)        │          0 │ pdf_integrand[0]… │
│ (xIntegrator)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ photon_integral     │ (1, 1, 1)         │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_x (InputLayer)  │ (1, 1, None, 14)  │          0 │ -                 │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ msr_weights         │ (1, 1, 14)        │          0 │ x_integrator[0][… │
│ (MSR_Normalization) │                   │            │ photon_integral[… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_normalized      │ (1, 1, None, 14)  │          0 │ pdf_x[0][0],      │
│ (Lambda)            │                   │            │ msr_weights[0][0] │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 0 (0.00 B)
 Trainable params: 0 (0.00 B)
 Non-trainable params: 0 (0.00 B)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'pdf_input': 'pdf_input', 'xgrid_integration': 'xgrid_integration'}
Received: inputs={'pdf_input': 'Tensor(shape=(1, 152, 1))', 'xgrid_integration': 'Tensor(shape=(1, 2000, 1))'}
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 2000, 2))
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 152, 2))
  warnings.warn(msg)
[INFO]:  > Latest 100 average: 0.014598 s
[INFO]: Epoch 100/900: loss: 7211.5000000
Validation loss after training step: 94.1275940.
Validation chi2s: DEUTERON: 100.673, ATLAS: 70.326, total: 94.128
[INFO]:  > Latest 100 average: 0.012897 s
[INFO]: Epoch 200/900: loss: 1107.8437500
Validation loss after training step: 8.8759718.
Validation chi2s: DEUTERON: 10.275, ATLAS: 3.788, total: 8.876
[INFO]:  > Latest 100 average: 0.013992 s
[INFO]: Epoch 300/900: loss: 237.1561279
Validation loss after training step: 2.1302688.
Validation chi2s: DEUTERON: 1.512, ATLAS: 4.378, total: 2.130
[INFO]:  > Latest 100 average: 0.011592 s
[INFO]: Epoch 400/900: loss: 220.8972473
Validation loss after training step: 2.3502774.
Validation chi2s: DEUTERON: 1.996, ATLAS: 3.638, total: 2.350
[INFO]:  > Latest 100 average: 0.012784 s
[INFO]: Epoch 500/900: loss: 221.3707733
Validation loss after training step: 2.3784189.
Validation chi2s: DEUTERON: 1.830, ATLAS: 4.372, total: 2.378
[INFO]:  > Latest 100 average: 0.012459 s
[INFO]: Epoch 600/900: loss: 221.8198242
Validation loss after training step: 2.3784046.
Validation chi2s: DEUTERON: 1.820, ATLAS: 4.407, total: 2.378
[INFO]:  > Latest 100 average: 0.011399 s
[INFO]: Epoch 700/900: loss: 219.7117767
Validation loss after training step: 2.2610986.
Validation chi2s: DEUTERON: 1.719, ATLAS: 4.231, total: 2.261
[INFO]:  > Latest 100 average: 0.012205 s
[INFO]: Epoch 800/900: loss: 219.5002899
Validation loss after training step: 2.4073892.
Validation chi2s: DEUTERON: 1.792, ATLAS: 4.645, total: 2.407
[INFO]:  > Latest 100 average: 0.011938 s
[INFO]: Epoch 900/900: loss: 218.9354401
Validation loss after training step: 2.0707119.
Validation chi2s: DEUTERON: 1.711, ATLAS: 3.380, total: 2.071
[INFO]: > > Average time per epoch: 0.01221 +- 0.0043705 s
[INFO]: > > > Total time: 0.18988 min
[INFO]: Stopped at epoch=900
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 199, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 131ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 141ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 14ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 24ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 14ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 25ms/step
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, None, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 150ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 160ms/step
[INFO]: Best fit for replica #4, chi2=0.920 (tr=1.493, vl=1.875)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 14ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 24ms/step
[INFO]:  > Saving the weights for future in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_4/weights.h5
[INFO]: Tensorboard logging information is stored at /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_4/tboard
2025-04-03 19:41:12.371542: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: SSE4.1 SSE4.2 AVX AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
[INFO]: Creating replica output folder in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_5
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[INFO]: All requirements processed and checked successfully. Executing actions.
[INFO]: Loading integrability dataset NNPDF_INTEG_3GEV_XT3
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_F2U
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_XGL
[INFO]: Setting debug seed to: 13
[INFO]: Clearing session
[INFO]: Setting the number of cores to: 1
[INFO]: Starting sequential fits from replica 5 to 5
[INFO]: Starting replica fit (5,)
[INFO]: Clearing session
[INFO]: Generating layers
[INFO]: Generating layers for experiment DEUTERON
[INFO]: Generating layers for experiment ATLAS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_F2U
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_XGL
[INFO]: Generating integrability penalty for NNPDF_INTEG_3GEV_XT3
[INFO]: Generating the input grid
[INFO]: Generating PDF models
[INFO]: Generating the Model
Using Keras backend

Model: "meta_model"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ PDFs (MetaModel)    │ (1, 1, None, 14)  │        309 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ splitter (Lambda)   │ [(1, 1, 62, 14),  │          0 │ PDFs[0][0]        │
│                     │ (1, 1, 38, 14),   │            │                   │
│                     │ (1, 1, 50, 14),   │            │                   │
│                     │ (1, 1, 2, 14)]    │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON_split      │ [(1, 1, 36, 14),  │          0 │ splitter[0][0]    │
│ (Lambda)            │ (1, 1, 26, 14)]   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NMC_NC_NOTFIXE… │ (1, 1, 121)       │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_SLAC_NC_NOTFIX… │ (1, 1, 34)        │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_ATLAS_Z0J_8TEV… │ (1, 1, 44)        │          0 │ splitter[0][1]    │
│ (DY)                │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 20)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 19)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 10)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate         │ (1, 1, 155)       │          0 │ dat_NMC_NC_NOTFI… │
│ (Concatenate)       │                   │            │ dat_SLAC_NC_NOTF… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_1       │ (1, 1, 44)        │          0 │ dat_ATLAS_Z0J_8T… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_2       │ (1, 1, 20)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_3       │ (1, 1, 19)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_4       │ (1, 1, 10)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_INTEG_3G… │ (1, 1, 1)         │          0 │ splitter[0][3]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_DEUTERON     │ (1, 1, 115)       │          0 │ concatenate[0][0] │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_ATLAS (Mask) │ (1, 1, 33)        │          0 │ concatenate_1[0]… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 20)        │          0 │ concatenate_2[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 19)        │          0 │ concatenate_3[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 10)        │          0 │ concatenate_4[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_5       │ (1, 1, 1)         │          0 │ dat_NNPDF_INTEG_… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON            │ (1)               │     13,340 │ trmask_DEUTERON[… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ ATLAS               │ (1)               │      1,122 │ trmask_ATLAS[0][… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_INTEG_3GEV_X… │ (1)               │          1 │ concatenate_5[0]… │
│ (LossIntegrability) │                   │            │                   │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 14,775 (57.71 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 14,472 (56.53 KB)
Model: "PDFs"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_logx (Lambda)     │ (1, None, 2)      │          0 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ preprocessing_fact… │ (1, 1, None, 8)   │         16 │ pdf_input[0][0],  │
│ (Preprocessing)     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ all_NNs (MetaModel) │ (1, 1, None, 8)   │        293 │ x_logx[0][0],     │
│                     │                   │            │ x_logx[1][0]      │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ prefactor_times_NN  │ (1, 1, None, 8)   │          0 │ preprocessing_fa… │
│ (Lambda)            │                   │            │ all_NNs[0][0],    │
│                     │                   │            │ preprocessing_fa… │
│                     │                   │            │ all_NNs[1][0]     │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_evolution_basis │ (1, 1, None, 9)   │          0 │ prefactor_times_… │
│ (FlavourToEvolutio… │                   │            │ prefactor_times_… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_FK_basis        │ (1, 1, None, 14)  │          0 │ pdf_evolution_ba… │
│ (FkRotation)        │                   │            │ pdf_evolution_ba… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ impose_msr          │ (1, 1, None, 14)  │          0 │ pdf_FK_basis[0][… │
│ (MetaModel)         │                   │            │ pdf_FK_basis[1][… │
│                     │                   │            │ xgrid_integratio… │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 309 (1.21 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 6 (24.00 B)
Model: "all_NNs"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ NN_input (InputLayer)           │ (1, None, 2)           │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ NN_0 (MetaModel)                │ (1, None, 8)           │           293 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ stack_replicas (Lambda)         │ (1, 1, None, 8)        │             0 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 293 (1.14 KB)
 Trainable params: 293 (1.14 KB)
 Non-trainable params: 0 (0.00 B)
Model: "impose_msr"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_divide (xDivide)  │ (1, None, 14)     │          0 │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_xgrid_integrat… │ (1, 1, 2000, 14)  │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_integrand       │ (1, 1, 2000, 14)  │          0 │ x_divide[0][0],   │
│ (Lambda)            │                   │            │ pdf_xgrid_integr… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_integrator        │ (1, 1, 14)        │          0 │ pdf_integrand[0]… │
│ (xIntegrator)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ photon_integral     │ (1, 1, 1)         │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_x (InputLayer)  │ (1, 1, None, 14)  │          0 │ -                 │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ msr_weights         │ (1, 1, 14)        │          0 │ x_integrator[0][… │
│ (MSR_Normalization) │                   │            │ photon_integral[… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_normalized      │ (1, 1, None, 14)  │          0 │ pdf_x[0][0],      │
│ (Lambda)            │                   │            │ msr_weights[0][0] │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 0 (0.00 B)
 Trainable params: 0 (0.00 B)
 Non-trainable params: 0 (0.00 B)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'pdf_input': 'pdf_input', 'xgrid_integration': 'xgrid_integration'}
Received: inputs={'pdf_input': 'Tensor(shape=(1, 152, 1))', 'xgrid_integration': 'Tensor(shape=(1, 2000, 1))'}
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 2000, 2))
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 152, 2))
  warnings.warn(msg)
[INFO]:  > Latest 100 average: 0.017237 s
[INFO]: Epoch 100/900: loss: 218.0000000
Validation loss after training step: 1.7878294.
Validation chi2s: DEUTERON: 1.850, ATLAS: 1.561, total: 1.788
[INFO]:  > Latest 100 average: 0.016188 s
[INFO]: Epoch 200/900: loss: 242.6977844
Validation loss after training step: 1.5622510.
Validation chi2s: DEUTERON: 1.538, ATLAS: 1.650, total: 1.562
[INFO]:  > Latest 100 average: 0.013741 s
[INFO]: Epoch 300/900: loss: 239.2619171
Validation loss after training step: 1.5355802.
Validation chi2s: DEUTERON: 1.483, ATLAS: 1.727, total: 1.536
[INFO]:  > Latest 100 average: 0.013654 s
[INFO]: Epoch 400/900: loss: 236.8546143
Validation loss after training step: 1.5230063.
Validation chi2s: DEUTERON: 1.446, ATLAS: 1.803, total: 1.523
[INFO]:  > Latest 100 average: 0.012314 s
[INFO]: Epoch 500/900: loss: 235.8838806
Validation loss after training step: 1.5323486.
Validation chi2s: DEUTERON: 1.430, ATLAS: 1.904, total: 1.532
[INFO]:  > Latest 100 average: 0.012936 s
[INFO]: Epoch 600/900: loss: 217.0801392
Validation loss after training step: 2.0589085.
Validation chi2s: DEUTERON: 1.948, ATLAS: 2.461, total: 2.059
[INFO]:  > Latest 100 average: 0.026044 s
[INFO]: Epoch 700/900: loss: 217.1512756
Validation loss after training step: 2.0653861.
Validation chi2s: DEUTERON: 1.931, ATLAS: 2.555, total: 2.065
[INFO]:  > Latest 100 average: 0.012678 s
[INFO]: Epoch 800/900: loss: 219.7085571
Validation loss after training step: 2.0962253.
Validation chi2s: DEUTERON: 1.991, ATLAS: 2.478, total: 2.096
[INFO]:  > Latest 100 average: 0.012535 s
[INFO]: Epoch 900/900: loss: 221.9334564
Validation loss after training step: 1.4993334.
Validation chi2s: DEUTERON: 1.408, ATLAS: 1.832, total: 1.499
[INFO]: > > Average time per epoch: 0.014786 +- 0.045993 s
[INFO]: > > > Total time: 0.22897 min
[INFO]: Stopped at epoch=900
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 199, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 130ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 140ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 12ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 22ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 14ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 24ms/step
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, None, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 149ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 160ms/step
[INFO]: Best fit for replica #5, chi2=0.907 (tr=1.477, vl=1.497)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 15ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 26ms/step
[INFO]:  > Saving the weights for future in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_5/weights.h5
[INFO]: Tensorboard logging information is stored at /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_5/tboard
2025-04-03 19:41:40.193479: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: SSE4.1 SSE4.2 AVX AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
[INFO]: Creating replica output folder in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_6
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[INFO]: All requirements processed and checked successfully. Executing actions.
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_F2U
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_XGL
[INFO]: Loading integrability dataset NNPDF_INTEG_3GEV_XT3
[INFO]: Setting debug seed to: 13
[INFO]: Clearing session
[INFO]: Setting the number of cores to: 1
[INFO]: Starting sequential fits from replica 6 to 6
[INFO]: Starting replica fit (6,)
[INFO]: Clearing session
[INFO]: Generating layers
[INFO]: Generating layers for experiment DEUTERON
[INFO]: Generating layers for experiment ATLAS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_F2U
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_XGL
[INFO]: Generating integrability penalty for NNPDF_INTEG_3GEV_XT3
[INFO]: Generating the input grid
[INFO]: Generating PDF models
[INFO]: Generating the Model
Using Keras backend

Model: "meta_model"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ PDFs (MetaModel)    │ (1, 1, None, 14)  │        309 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ splitter (Lambda)   │ [(1, 1, 62, 14),  │          0 │ PDFs[0][0]        │
│                     │ (1, 1, 38, 14),   │            │                   │
│                     │ (1, 1, 50, 14),   │            │                   │
│                     │ (1, 1, 2, 14)]    │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON_split      │ [(1, 1, 36, 14),  │          0 │ splitter[0][0]    │
│ (Lambda)            │ (1, 1, 26, 14)]   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NMC_NC_NOTFIXE… │ (1, 1, 121)       │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_SLAC_NC_NOTFIX… │ (1, 1, 34)        │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_ATLAS_Z0J_8TEV… │ (1, 1, 44)        │          0 │ splitter[0][1]    │
│ (DY)                │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 20)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 19)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 10)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate         │ (1, 1, 155)       │          0 │ dat_NMC_NC_NOTFI… │
│ (Concatenate)       │                   │            │ dat_SLAC_NC_NOTF… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_1       │ (1, 1, 44)        │          0 │ dat_ATLAS_Z0J_8T… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_2       │ (1, 1, 20)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_3       │ (1, 1, 19)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_4       │ (1, 1, 10)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_INTEG_3G… │ (1, 1, 1)         │          0 │ splitter[0][3]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_DEUTERON     │ (1, 1, 115)       │          0 │ concatenate[0][0] │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_ATLAS (Mask) │ (1, 1, 33)        │          0 │ concatenate_1[0]… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 20)        │          0 │ concatenate_2[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 19)        │          0 │ concatenate_3[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 10)        │          0 │ concatenate_4[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_5       │ (1, 1, 1)         │          0 │ dat_NNPDF_INTEG_… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON            │ (1)               │     13,340 │ trmask_DEUTERON[… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ ATLAS               │ (1)               │      1,122 │ trmask_ATLAS[0][… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_INTEG_3GEV_X… │ (1)               │          1 │ concatenate_5[0]… │
│ (LossIntegrability) │                   │            │                   │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 14,775 (57.71 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 14,472 (56.53 KB)
Model: "PDFs"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_logx (Lambda)     │ (1, None, 2)      │          0 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ preprocessing_fact… │ (1, 1, None, 8)   │         16 │ pdf_input[0][0],  │
│ (Preprocessing)     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ all_NNs (MetaModel) │ (1, 1, None, 8)   │        293 │ x_logx[0][0],     │
│                     │                   │            │ x_logx[1][0]      │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ prefactor_times_NN  │ (1, 1, None, 8)   │          0 │ preprocessing_fa… │
│ (Lambda)            │                   │            │ all_NNs[0][0],    │
│                     │                   │            │ preprocessing_fa… │
│                     │                   │            │ all_NNs[1][0]     │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_evolution_basis │ (1, 1, None, 9)   │          0 │ prefactor_times_… │
│ (FlavourToEvolutio… │                   │            │ prefactor_times_… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_FK_basis        │ (1, 1, None, 14)  │          0 │ pdf_evolution_ba… │
│ (FkRotation)        │                   │            │ pdf_evolution_ba… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ impose_msr          │ (1, 1, None, 14)  │          0 │ pdf_FK_basis[0][… │
│ (MetaModel)         │                   │            │ pdf_FK_basis[1][… │
│                     │                   │            │ xgrid_integratio… │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 309 (1.21 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 6 (24.00 B)
Model: "all_NNs"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ NN_input (InputLayer)           │ (1, None, 2)           │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ NN_0 (MetaModel)                │ (1, None, 8)           │           293 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ stack_replicas (Lambda)         │ (1, 1, None, 8)        │             0 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 293 (1.14 KB)
 Trainable params: 293 (1.14 KB)
 Non-trainable params: 0 (0.00 B)
Model: "impose_msr"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_divide (xDivide)  │ (1, None, 14)     │          0 │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_xgrid_integrat… │ (1, 1, 2000, 14)  │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_integrand       │ (1, 1, 2000, 14)  │          0 │ x_divide[0][0],   │
│ (Lambda)            │                   │            │ pdf_xgrid_integr… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_integrator        │ (1, 1, 14)        │          0 │ pdf_integrand[0]… │
│ (xIntegrator)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ photon_integral     │ (1, 1, 1)         │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_x (InputLayer)  │ (1, 1, None, 14)  │          0 │ -                 │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ msr_weights         │ (1, 1, 14)        │          0 │ x_integrator[0][… │
│ (MSR_Normalization) │                   │            │ photon_integral[… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_normalized      │ (1, 1, None, 14)  │          0 │ pdf_x[0][0],      │
│ (Lambda)            │                   │            │ msr_weights[0][0] │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 0 (0.00 B)
 Trainable params: 0 (0.00 B)
 Non-trainable params: 0 (0.00 B)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'pdf_input': 'pdf_input', 'xgrid_integration': 'xgrid_integration'}
Received: inputs={'pdf_input': 'Tensor(shape=(1, 152, 1))', 'xgrid_integration': 'Tensor(shape=(1, 2000, 1))'}
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 2000, 2))
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 152, 2))
  warnings.warn(msg)
[INFO]:  > Latest 100 average: 0.015797 s
[INFO]: Epoch 100/900: loss: 336.0000000
Validation loss after training step: 3.8612592.
Validation chi2s: DEUTERON: 4.129, ATLAS: 2.886, total: 3.861
[INFO]:  > Latest 100 average: 0.015009 s
[INFO]: Epoch 200/900: loss: 267.0003357
Validation loss after training step: 2.2852015.
Validation chi2s: DEUTERON: 2.468, ATLAS: 1.619, total: 2.285
[INFO]:  > Latest 100 average: 0.013287 s
[INFO]: Epoch 300/900: loss: 263.7115479
Validation loss after training step: 1.9482844.
Validation chi2s: DEUTERON: 2.114, ATLAS: 1.347, total: 1.948
[INFO]:  > Latest 100 average: 0.012399 s
[INFO]: Epoch 400/900: loss: 267.1871948
Validation loss after training step: 2.1858442.
Validation chi2s: DEUTERON: 2.287, ATLAS: 1.818, total: 2.186
[INFO]:  > Latest 100 average: 0.012237 s
[INFO]: Epoch 500/900: loss: 247.9289551
Validation loss after training step: 1.9410002.
Validation chi2s: DEUTERON: 2.106, ATLAS: 1.342, total: 1.941
[INFO]:  > Latest 100 average: 0.013022 s
[INFO]: Epoch 600/900: loss: 251.6958618
Validation loss after training step: 2.1963556.
Validation chi2s: DEUTERON: 2.332, ATLAS: 1.704, total: 2.196
[INFO]:  > Latest 100 average: 0.012261 s
[INFO]: Epoch 700/900: loss: 246.8483887
Validation loss after training step: 2.0835631.
Validation chi2s: DEUTERON: 2.136, ATLAS: 1.892, total: 2.084
[INFO]:  > Latest 100 average: 0.01213 s
[INFO]: Epoch 800/900: loss: 252.8322754
Validation loss after training step: 1.7734109.
Validation chi2s: DEUTERON: 1.862, ATLAS: 1.453, total: 1.773
[INFO]:  > Latest 100 average: 0.012905 s
[INFO]: Epoch 900/900: loss: 245.4076538
Validation loss after training step: 2.1209507.
Validation chi2s: DEUTERON: 2.271, ATLAS: 1.575, total: 2.121
[INFO]: > > Average time per epoch: 0.012681 +- 0.0044266 s
[INFO]: > > > Total time: 0.19853 min
[INFO]: Stopped at epoch=900
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 199, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 129ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 140ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 14ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 24ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 14ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 24ms/step
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, None, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 147ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 158ms/step
[INFO]: Best fit for replica #6, chi2=0.831 (tr=1.632, vl=1.717)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 15ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 25ms/step
[INFO]:  > Saving the weights for future in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_6/weights.h5
[INFO]: Tensorboard logging information is stored at /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_6/tboard
2025-04-03 19:42:06.213805: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: SSE4.1 SSE4.2 AVX AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
[INFO]: Creating replica output folder in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_7
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[INFO]: All requirements processed and checked successfully. Executing actions.
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_F2U
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_XGL
[INFO]: Loading integrability dataset NNPDF_INTEG_3GEV_XT3
[INFO]: Setting debug seed to: 13
[INFO]: Clearing session
[INFO]: Setting the number of cores to: 1
[INFO]: Starting sequential fits from replica 7 to 7
[INFO]: Starting replica fit (7,)
[INFO]: Clearing session
[INFO]: Generating layers
[INFO]: Generating layers for experiment DEUTERON
[INFO]: Generating layers for experiment ATLAS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_F2U
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_XGL
[INFO]: Generating integrability penalty for NNPDF_INTEG_3GEV_XT3
[INFO]: Generating the input grid
[INFO]: Generating PDF models
[INFO]: Generating the Model
Using Keras backend

Model: "meta_model"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ PDFs (MetaModel)    │ (1, 1, None, 14)  │        309 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ splitter (Lambda)   │ [(1, 1, 62, 14),  │          0 │ PDFs[0][0]        │
│                     │ (1, 1, 38, 14),   │            │                   │
│                     │ (1, 1, 50, 14),   │            │                   │
│                     │ (1, 1, 2, 14)]    │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON_split      │ [(1, 1, 36, 14),  │          0 │ splitter[0][0]    │
│ (Lambda)            │ (1, 1, 26, 14)]   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NMC_NC_NOTFIXE… │ (1, 1, 121)       │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_SLAC_NC_NOTFIX… │ (1, 1, 34)        │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_ATLAS_Z0J_8TEV… │ (1, 1, 44)        │          0 │ splitter[0][1]    │
│ (DY)                │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 20)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 19)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 10)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate         │ (1, 1, 155)       │          0 │ dat_NMC_NC_NOTFI… │
│ (Concatenate)       │                   │            │ dat_SLAC_NC_NOTF… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_1       │ (1, 1, 44)        │          0 │ dat_ATLAS_Z0J_8T… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_2       │ (1, 1, 20)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_3       │ (1, 1, 19)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_4       │ (1, 1, 10)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_INTEG_3G… │ (1, 1, 1)         │          0 │ splitter[0][3]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_DEUTERON     │ (1, 1, 115)       │          0 │ concatenate[0][0] │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_ATLAS (Mask) │ (1, 1, 33)        │          0 │ concatenate_1[0]… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 20)        │          0 │ concatenate_2[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 19)        │          0 │ concatenate_3[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 10)        │          0 │ concatenate_4[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_5       │ (1, 1, 1)         │          0 │ dat_NNPDF_INTEG_… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON            │ (1)               │     13,340 │ trmask_DEUTERON[… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ ATLAS               │ (1)               │      1,122 │ trmask_ATLAS[0][… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_INTEG_3GEV_X… │ (1)               │          1 │ concatenate_5[0]… │
│ (LossIntegrability) │                   │            │                   │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 14,775 (57.71 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 14,472 (56.53 KB)
Model: "PDFs"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_logx (Lambda)     │ (1, None, 2)      │          0 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ preprocessing_fact… │ (1, 1, None, 8)   │         16 │ pdf_input[0][0],  │
│ (Preprocessing)     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ all_NNs (MetaModel) │ (1, 1, None, 8)   │        293 │ x_logx[0][0],     │
│                     │                   │            │ x_logx[1][0]      │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ prefactor_times_NN  │ (1, 1, None, 8)   │          0 │ preprocessing_fa… │
│ (Lambda)            │                   │            │ all_NNs[0][0],    │
│                     │                   │            │ preprocessing_fa… │
│                     │                   │            │ all_NNs[1][0]     │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_evolution_basis │ (1, 1, None, 9)   │          0 │ prefactor_times_… │
│ (FlavourToEvolutio… │                   │            │ prefactor_times_… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_FK_basis        │ (1, 1, None, 14)  │          0 │ pdf_evolution_ba… │
│ (FkRotation)        │                   │            │ pdf_evolution_ba… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ impose_msr          │ (1, 1, None, 14)  │          0 │ pdf_FK_basis[0][… │
│ (MetaModel)         │                   │            │ pdf_FK_basis[1][… │
│                     │                   │            │ xgrid_integratio… │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 309 (1.21 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 6 (24.00 B)
Model: "all_NNs"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ NN_input (InputLayer)           │ (1, None, 2)           │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ NN_0 (MetaModel)                │ (1, None, 8)           │           293 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ stack_replicas (Lambda)         │ (1, 1, None, 8)        │             0 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 293 (1.14 KB)
 Trainable params: 293 (1.14 KB)
 Non-trainable params: 0 (0.00 B)
Model: "impose_msr"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_divide (xDivide)  │ (1, None, 14)     │          0 │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_xgrid_integrat… │ (1, 1, 2000, 14)  │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_integrand       │ (1, 1, 2000, 14)  │          0 │ x_divide[0][0],   │
│ (Lambda)            │                   │            │ pdf_xgrid_integr… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_integrator        │ (1, 1, 14)        │          0 │ pdf_integrand[0]… │
│ (xIntegrator)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ photon_integral     │ (1, 1, 1)         │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_x (InputLayer)  │ (1, 1, None, 14)  │          0 │ -                 │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ msr_weights         │ (1, 1, 14)        │          0 │ x_integrator[0][… │
│ (MSR_Normalization) │                   │            │ photon_integral[… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_normalized      │ (1, 1, None, 14)  │          0 │ pdf_x[0][0],      │
│ (Lambda)            │                   │            │ msr_weights[0][0] │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 0 (0.00 B)
 Trainable params: 0 (0.00 B)
 Non-trainable params: 0 (0.00 B)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'pdf_input': 'pdf_input', 'xgrid_integration': 'xgrid_integration'}
Received: inputs={'pdf_input': 'Tensor(shape=(1, 152, 1))', 'xgrid_integration': 'Tensor(shape=(1, 2000, 1))'}
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 2000, 2))
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 152, 2))
  warnings.warn(msg)
[INFO]:  > Latest 100 average: 0.015825 s
[INFO]: Epoch 100/900: loss: 270.2500000
Validation loss after training step: 4.2169356.
Validation chi2s: DEUTERON: 5.156, ATLAS: 0.802, total: 4.217
[INFO]:  > Latest 100 average: 0.015053 s
[INFO]: Epoch 200/900: loss: 402.3347168
Validation loss after training step: 3.8580947.
Validation chi2s: DEUTERON: 4.677, ATLAS: 0.881, total: 3.858
[INFO]:  > Latest 100 average: 0.027401 s
[INFO]: Epoch 300/900: loss: 220.5347595
Validation loss after training step: 3.0581970.
Validation chi2s: DEUTERON: 3.596, ATLAS: 1.101, total: 3.058
[INFO]:  > Latest 100 average: 0.024373 s
[INFO]: Epoch 400/900: loss: 217.2762146
Validation loss after training step: 2.4376376.
Validation chi2s: DEUTERON: 2.765, ATLAS: 1.249, total: 2.438
[INFO]:  > Latest 100 average: 0.013248 s
[INFO]: Epoch 500/900: loss: 202.4381409
Validation loss after training step: 2.1839480.
Validation chi2s: DEUTERON: 2.425, ATLAS: 1.308, total: 2.184
[INFO]:  > Latest 100 average: 0.015551 s
[INFO]: Epoch 600/900: loss: 195.7340698
Validation loss after training step: 2.2245207.
Validation chi2s: DEUTERON: 2.549, ATLAS: 1.044, total: 2.225
[INFO]:  > Latest 100 average: 0.014592 s
[INFO]: Epoch 700/900: loss: 191.2303467
Validation loss after training step: 2.1717644.
Validation chi2s: DEUTERON: 2.423, ATLAS: 1.256, total: 2.172
[INFO]:  > Latest 100 average: 0.01545 s
[INFO]: Epoch 800/900: loss: 186.2504272
Validation loss after training step: 2.2341192.
Validation chi2s: DEUTERON: 2.472, ATLAS: 1.369, total: 2.234
[INFO]:  > Latest 100 average: 0.01506 s
[INFO]: Epoch 900/900: loss: 183.7720490
Validation loss after training step: 2.3620028.
Validation chi2s: DEUTERON: 2.661, ATLAS: 1.275, total: 2.362
[INFO]: > > Average time per epoch: 0.017454 +- 0.055972 s
[INFO]: > > > Total time: 0.26111 min
[INFO]: Stopped at epoch=900
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 199, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 118ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 128ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 13ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 23ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 14ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 24ms/step
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, None, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 142ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 152ms/step
[INFO]: Best fit for replica #7, chi2=0.843 (tr=1.250, vl=1.999)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 14ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 23ms/step
[INFO]:  > Saving the weights for future in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_7/weights.h5
[INFO]: Tensorboard logging information is stored at /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_7/tboard
2025-04-03 19:42:36.061217: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: SSE4.1 SSE4.2 AVX AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
[INFO]: Creating replica output folder in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_8
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[INFO]: All requirements processed and checked successfully. Executing actions.
[INFO]: Loading integrability dataset NNPDF_INTEG_3GEV_XT3
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_F2U
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_XGL
[INFO]: Setting debug seed to: 13
[INFO]: Clearing session
[INFO]: Setting the number of cores to: 1
[INFO]: Starting sequential fits from replica 8 to 8
[INFO]: Starting replica fit (8,)
[INFO]: Clearing session
[INFO]: Generating layers
[INFO]: Generating layers for experiment DEUTERON
[INFO]: Generating layers for experiment ATLAS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_F2U
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_XGL
[INFO]: Generating integrability penalty for NNPDF_INTEG_3GEV_XT3
[INFO]: Generating the input grid
[INFO]: Generating PDF models
[INFO]: Generating the Model
Using Keras backend

Model: "meta_model"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ PDFs (MetaModel)    │ (1, 1, None, 14)  │        309 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ splitter (Lambda)   │ [(1, 1, 62, 14),  │          0 │ PDFs[0][0]        │
│                     │ (1, 1, 38, 14),   │            │                   │
│                     │ (1, 1, 50, 14),   │            │                   │
│                     │ (1, 1, 2, 14)]    │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON_split      │ [(1, 1, 36, 14),  │          0 │ splitter[0][0]    │
│ (Lambda)            │ (1, 1, 26, 14)]   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NMC_NC_NOTFIXE… │ (1, 1, 121)       │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_SLAC_NC_NOTFIX… │ (1, 1, 34)        │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_ATLAS_Z0J_8TEV… │ (1, 1, 44)        │          0 │ splitter[0][1]    │
│ (DY)                │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 20)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 19)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 10)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate         │ (1, 1, 155)       │          0 │ dat_NMC_NC_NOTFI… │
│ (Concatenate)       │                   │            │ dat_SLAC_NC_NOTF… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_1       │ (1, 1, 44)        │          0 │ dat_ATLAS_Z0J_8T… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_2       │ (1, 1, 20)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_3       │ (1, 1, 19)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_4       │ (1, 1, 10)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_INTEG_3G… │ (1, 1, 1)         │          0 │ splitter[0][3]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_DEUTERON     │ (1, 1, 115)       │          0 │ concatenate[0][0] │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_ATLAS (Mask) │ (1, 1, 33)        │          0 │ concatenate_1[0]… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 20)        │          0 │ concatenate_2[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 19)        │          0 │ concatenate_3[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 10)        │          0 │ concatenate_4[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_5       │ (1, 1, 1)         │          0 │ dat_NNPDF_INTEG_… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON            │ (1)               │     13,340 │ trmask_DEUTERON[… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ ATLAS               │ (1)               │      1,122 │ trmask_ATLAS[0][… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_INTEG_3GEV_X… │ (1)               │          1 │ concatenate_5[0]… │
│ (LossIntegrability) │                   │            │                   │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 14,775 (57.71 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 14,472 (56.53 KB)
Model: "PDFs"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_logx (Lambda)     │ (1, None, 2)      │          0 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ preprocessing_fact… │ (1, 1, None, 8)   │         16 │ pdf_input[0][0],  │
│ (Preprocessing)     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ all_NNs (MetaModel) │ (1, 1, None, 8)   │        293 │ x_logx[0][0],     │
│                     │                   │            │ x_logx[1][0]      │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ prefactor_times_NN  │ (1, 1, None, 8)   │          0 │ preprocessing_fa… │
│ (Lambda)            │                   │            │ all_NNs[0][0],    │
│                     │                   │            │ preprocessing_fa… │
│                     │                   │            │ all_NNs[1][0]     │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_evolution_basis │ (1, 1, None, 9)   │          0 │ prefactor_times_… │
│ (FlavourToEvolutio… │                   │            │ prefactor_times_… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_FK_basis        │ (1, 1, None, 14)  │          0 │ pdf_evolution_ba… │
│ (FkRotation)        │                   │            │ pdf_evolution_ba… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ impose_msr          │ (1, 1, None, 14)  │          0 │ pdf_FK_basis[0][… │
│ (MetaModel)         │                   │            │ pdf_FK_basis[1][… │
│                     │                   │            │ xgrid_integratio… │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 309 (1.21 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 6 (24.00 B)
Model: "all_NNs"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ NN_input (InputLayer)           │ (1, None, 2)           │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ NN_0 (MetaModel)                │ (1, None, 8)           │           293 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ stack_replicas (Lambda)         │ (1, 1, None, 8)        │             0 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 293 (1.14 KB)
 Trainable params: 293 (1.14 KB)
 Non-trainable params: 0 (0.00 B)
Model: "impose_msr"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_divide (xDivide)  │ (1, None, 14)     │          0 │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_xgrid_integrat… │ (1, 1, 2000, 14)  │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_integrand       │ (1, 1, 2000, 14)  │          0 │ x_divide[0][0],   │
│ (Lambda)            │                   │            │ pdf_xgrid_integr… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_integrator        │ (1, 1, 14)        │          0 │ pdf_integrand[0]… │
│ (xIntegrator)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ photon_integral     │ (1, 1, 1)         │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_x (InputLayer)  │ (1, 1, None, 14)  │          0 │ -                 │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ msr_weights         │ (1, 1, 14)        │          0 │ x_integrator[0][… │
│ (MSR_Normalization) │                   │            │ photon_integral[… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_normalized      │ (1, 1, None, 14)  │          0 │ pdf_x[0][0],      │
│ (Lambda)            │                   │            │ msr_weights[0][0] │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 0 (0.00 B)
 Trainable params: 0 (0.00 B)
 Non-trainable params: 0 (0.00 B)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'pdf_input': 'pdf_input', 'xgrid_integration': 'xgrid_integration'}
Received: inputs={'pdf_input': 'Tensor(shape=(1, 152, 1))', 'xgrid_integration': 'Tensor(shape=(1, 2000, 1))'}
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 2000, 2))
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 152, 2))
  warnings.warn(msg)
[INFO]:  > Latest 100 average: 0.019266 s
[INFO]: Epoch 100/900: loss: 6400.0000000
Validation loss after training step: 3.1197808.
Validation chi2s: DEUTERON: 2.655, ATLAS: 4.809, total: 3.120
[INFO]:  > Latest 100 average: 0.016372 s
[INFO]: Epoch 200/900: loss: 357.6123047
Validation loss after training step: 2.2051075.
Validation chi2s: DEUTERON: 1.905, ATLAS: 3.295, total: 2.205
[INFO]:  > Latest 100 average: 0.024827 s
[INFO]: Epoch 300/900: loss: 259.2734375
Validation loss after training step: 1.6770936.
Validation chi2s: DEUTERON: 1.283, ATLAS: 3.109, total: 1.677
[INFO]:  > Latest 100 average: 0.026266 s
[INFO]: Epoch 400/900: loss: 227.4709473
Validation loss after training step: 1.8499861.
Validation chi2s: DEUTERON: 1.512, ATLAS: 3.080, total: 1.850
[INFO]:  > Latest 100 average: 0.013288 s
[INFO]: Epoch 500/900: loss: 227.0219727
Validation loss after training step: 1.7902755.
Validation chi2s: DEUTERON: 1.507, ATLAS: 2.821, total: 1.790
[INFO]:  > Latest 100 average: 0.014318 s
[INFO]: Epoch 600/900: loss: 219.3420410
Validation loss after training step: 1.9515557.
Validation chi2s: DEUTERON: 1.698, ATLAS: 2.873, total: 1.952
[INFO]: > > Average time per epoch: 0.020366 +- 0.085968 s
[INFO]: > > > Total time: 0.21982 min
[INFO]: Stopped at epoch=646
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 199, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 142ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 154ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 15ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 26ms/step
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 15ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 25ms/step
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, None, 2))
  warnings.warn(msg)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 169ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 180ms/step
[INFO]: Best fit for replica #8, chi2=0.857 (tr=1.558, vl=1.515)
[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 18ms/step[1m1/1[0m [32m━━━━━━━━━━━━━━━━━━━━[0m[37m[0m [1m0s[0m 28ms/step
[INFO]:  > Saving the weights for future in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_8/weights.h5
[INFO]: Tensorboard logging information is stored at /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_8/tboard
2025-04-03 19:43:04.531039: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: SSE4.1 SSE4.2 AVX AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
[INFO]: Creating replica output folder in /mnt/storage/laurent/NNPDF/Basic_runcard/nnfit/replica_9
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[WARNING]: Using q2min from runcard
[WARNING]: Using w2min from runcard
[INFO]: All requirements processed and checked successfully. Executing actions.
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_F2U
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Loading positivity dataset NNPDF_POS_2P24GEV_XGL
[INFO]: Loading integrability dataset NNPDF_INTEG_3GEV_XT3
[INFO]: Setting debug seed to: 13
[INFO]: Clearing session
[INFO]: Setting the number of cores to: 1
[INFO]: Starting sequential fits from replica 9 to 9
[INFO]: Starting replica fit (9,)
[INFO]: Clearing session
[INFO]: Generating layers
[INFO]: Generating layers for experiment DEUTERON
[INFO]: Generating layers for experiment ATLAS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_F2U
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_FLL-19PTS
[INFO]: Generating positivity penalty for NNPDF_POS_2P24GEV_XGL
[INFO]: Generating integrability penalty for NNPDF_INTEG_3GEV_XT3
[INFO]: Generating the input grid
[INFO]: Generating PDF models
[INFO]: Generating the Model
Using Keras backend

Model: "meta_model"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ PDFs (MetaModel)    │ (1, 1, None, 14)  │        309 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ splitter (Lambda)   │ [(1, 1, 62, 14),  │          0 │ PDFs[0][0]        │
│                     │ (1, 1, 38, 14),   │            │                   │
│                     │ (1, 1, 50, 14),   │            │                   │
│                     │ (1, 1, 2, 14)]    │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON_split      │ [(1, 1, 36, 14),  │          0 │ splitter[0][0]    │
│ (Lambda)            │ (1, 1, 26, 14)]   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NMC_NC_NOTFIXE… │ (1, 1, 121)       │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_SLAC_NC_NOTFIX… │ (1, 1, 34)        │          0 │ DEUTERON_split[0… │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_ATLAS_Z0J_8TEV… │ (1, 1, 44)        │          0 │ splitter[0][1]    │
│ (DY)                │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 20)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 19)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_POS_2P24… │ (1, 1, 10)        │          0 │ splitter[0][2]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate         │ (1, 1, 155)       │          0 │ dat_NMC_NC_NOTFI… │
│ (Concatenate)       │                   │            │ dat_SLAC_NC_NOTF… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_1       │ (1, 1, 44)        │          0 │ dat_ATLAS_Z0J_8T… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_2       │ (1, 1, 20)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_3       │ (1, 1, 19)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_4       │ (1, 1, 10)        │          0 │ dat_NNPDF_POS_2P… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ dat_NNPDF_INTEG_3G… │ (1, 1, 1)         │          0 │ splitter[0][3]    │
│ (DIS)               │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_DEUTERON     │ (1, 1, 115)       │          0 │ concatenate[0][0] │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_ATLAS (Mask) │ (1, 1, 33)        │          0 │ concatenate_1[0]… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 20)        │          0 │ concatenate_2[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 19)        │          0 │ concatenate_3[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ trmask_NNPDF_POS_2… │ (1, 1, 10)        │          0 │ concatenate_4[0]… │
│ (Mask)              │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ concatenate_5       │ (1, 1, 1)         │          0 │ dat_NNPDF_INTEG_… │
│ (Concatenate)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ DEUTERON            │ (1)               │     13,340 │ trmask_DEUTERON[… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ ATLAS               │ (1)               │      1,122 │ trmask_ATLAS[0][… │
│ (LossInvcovmat)     │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_POS_2P24GEV_… │ (1)               │          1 │ trmask_NNPDF_POS… │
│ (LossPositivity)    │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ NNPDF_INTEG_3GEV_X… │ (1)               │          1 │ concatenate_5[0]… │
│ (LossIntegrability) │                   │            │                   │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 14,775 (57.71 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 14,472 (56.53 KB)
Model: "PDFs"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ pdf_input           │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_logx (Lambda)     │ (1, None, 2)      │          0 │ pdf_input[0][0],  │
│                     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ preprocessing_fact… │ (1, 1, None, 8)   │         16 │ pdf_input[0][0],  │
│ (Preprocessing)     │                   │            │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ all_NNs (MetaModel) │ (1, 1, None, 8)   │        293 │ x_logx[0][0],     │
│                     │                   │            │ x_logx[1][0]      │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ prefactor_times_NN  │ (1, 1, None, 8)   │          0 │ preprocessing_fa… │
│ (Lambda)            │                   │            │ all_NNs[0][0],    │
│                     │                   │            │ preprocessing_fa… │
│                     │                   │            │ all_NNs[1][0]     │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_evolution_basis │ (1, 1, None, 9)   │          0 │ prefactor_times_… │
│ (FlavourToEvolutio… │                   │            │ prefactor_times_… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_FK_basis        │ (1, 1, None, 14)  │          0 │ pdf_evolution_ba… │
│ (FkRotation)        │                   │            │ pdf_evolution_ba… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ impose_msr          │ (1, 1, None, 14)  │          0 │ pdf_FK_basis[0][… │
│ (MetaModel)         │                   │            │ pdf_FK_basis[1][… │
│                     │                   │            │ xgrid_integratio… │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 309 (1.21 KB)
 Trainable params: 303 (1.18 KB)
 Non-trainable params: 6 (24.00 B)
Model: "all_NNs"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ NN_input (InputLayer)           │ (1, None, 2)           │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ NN_0 (MetaModel)                │ (1, None, 8)           │           293 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ stack_replicas (Lambda)         │ (1, 1, None, 8)        │             0 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 293 (1.14 KB)
 Trainable params: 293 (1.14 KB)
 Non-trainable params: 0 (0.00 B)
Model: "impose_msr"
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Layer (type)        ┃ Output Shape      ┃    Param # ┃ Connected to      ┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ xgrid_integration   │ (1, None, 1)      │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_divide (xDivide)  │ (1, None, 14)     │          0 │ xgrid_integratio… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_xgrid_integrat… │ (1, 1, 2000, 14)  │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_integrand       │ (1, 1, 2000, 14)  │          0 │ x_divide[0][0],   │
│ (Lambda)            │                   │            │ pdf_xgrid_integr… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ x_integrator        │ (1, 1, 14)        │          0 │ pdf_integrand[0]… │
│ (xIntegrator)       │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ photon_integral     │ (1, 1, 1)         │          0 │ -                 │
│ (InputLayer)        │                   │            │                   │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_x (InputLayer)  │ (1, 1, None, 14)  │          0 │ -                 │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ msr_weights         │ (1, 1, 14)        │          0 │ x_integrator[0][… │
│ (MSR_Normalization) │                   │            │ photon_integral[… │
├─────────────────────┼───────────────────┼────────────┼───────────────────┤
│ pdf_normalized      │ (1, 1, None, 14)  │          0 │ pdf_x[0][0],      │
│ (Lambda)            │                   │            │ msr_weights[0][0] │
└─────────────────────┴───────────────────┴────────────┴───────────────────┘
 Total params: 0 (0.00 B)
 Trainable params: 0 (0.00 B)
 Non-trainable params: 0 (0.00 B)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'pdf_input': 'pdf_input', 'xgrid_integration': 'xgrid_integration'}
Received: inputs={'pdf_input': 'Tensor(shape=(1, 152, 1))', 'xgrid_integration': 'Tensor(shape=(1, 2000, 1))'}
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 2000, 2))
  warnings.warn(msg)
/home/klaurent/.conda/envs/nnpdf/lib/python3.9/site-packages/keras/src/models/functional.py:238: UserWarning: The structure of `inputs` doesn't match the expected structure.
Expected: {'NN_input': 'NN_input'}
Received: inputs=Tensor(shape=(1, 152, 2))
  warnings.warn(msg)
[INFO]:  > Latest 100 average: 0.017603 s
[INFO]: Epoch 100/900: loss: 384.0000000
Validation loss after training step: 3.2874277.
Validation chi2s: DEUTERON: 3.251, ATLAS: 3.419, total: 3.287
[INFO]:  > Latest 100 average: 0.015252 s
[INFO]: Epoch 200/900: loss: 305.3581238
Validation loss after training step: 2.2364068.
Validation chi2s: DEUTERON: 1.717, ATLAS: 4.125, total: 2.236
